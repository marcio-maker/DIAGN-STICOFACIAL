<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabelo por Marcio | Diagn√≥stico Facial 3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #00D1FF;
            --primary-light: rgba(0, 209, 255, 0.2);
            --secondary: #9C27B0;
            --dark: #12141D;
            --darker: #0A0B10;
            --light: #F0F4FF;
            --gold: #FFD700;
            --tech-gradient: linear-gradient(135deg, #00D1FF 0%, #9C27B0 100%);
            --card-bg: rgba(18, 20, 29, 0.8);
            --neon-shadow: 0 0 15px rgba(0, 209, 255, 0.5);
            --font-main: 'Montserrat', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background: var(--dark);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--darker);
        }

        header {
            background: rgba(10, 11, 16, 0.9);
            padding: 1.5rem 0;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            z-index: 10;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 209, 255, 0.1);
        }

        header h1 {
            font-family: var(--font-tech);
            font-size: 2.2rem;
            background: var(--tech-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        header p {
            color: var(--primary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            letter-spacing: 1px;
            font-weight: 300;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            gap: 2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        .scanner-section {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--neon-shadow);
            height: 500px;
            background: var(--darker);
            border: 1px solid rgba(0, 209, 255, 0.1);
        }

        #webcam, #canvas, #staticCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #staticCanvas {
            z-index: 20;
            pointer-events: none;
        }

        #scanOverlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 20, 40, 0.7) 0%, rgba(5, 10, 20, 0.9) 100%);
            display: none;
            z-index: 5;
        }

        #scanLine {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            box-shadow: 0 0 20px var(--primary);
            top: 0;
            left: 0;
            z-index: 15;
            animation: scan 3s linear infinite;
            display: none;
        }

        @keyframes scan {
            0% { top: -10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110%; opacity: 0; }
        }

        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem 3rem;
            font-family: var(--font-tech);
            font-size: 1.5rem;
            font-weight: 500;
            background: rgba(0, 209, 255, 0.1);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 50px;
            cursor: pointer;
            box-shadow: var(--neon-shadow);
            transition: all 0.4s;
            z-index: 100;
            text-transform: uppercase;
            letter-spacing: 3px;
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        #startButton:hover {
            background: rgba(0, 209, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 209, 255, 0.7);
            transform: translate(-50%, -50%) scale(1.05);
        }

        #startButton::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                transparent 45%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 55%
            );
            transform: rotate(30deg);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }

        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 380px;
            border: 2px dashed var(--primary);
            border-radius: 40%;
            display: none;
            z-index: 10;
            pointer-events: none;
            box-shadow: inset 0 0 30px var(--primary), 0 0 30px var(--primary);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            color: var(--light);
            font-family: var(--font-tech);
            font-size: 1rem;
            z-index: 50;
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-radius: 50px;
            display: none;
            text-align: center;
            box-shadow: var(--neon-shadow);
            border: 1px solid var(--primary);
            backdrop-filter: blur(5px);
            letter-spacing: 1px;
        }

        .progress-container {
            position: absolute;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            max-width: 400px;
            height: 8px;
            background: rgba(100, 150, 200, 0.1);
            border-radius: 4px;
            overflow: hidden;
            display: none;
            z-index: 50;
            box-shadow: inset 0 0 10px rgba(0, 50, 100, 0.3);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--tech-gradient);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        #resultContainer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 25;
            background: rgba(5, 10, 20, 0.9);
            backdrop-filter: blur(5px);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s ease;
        }

        #resultContainer.active {
            opacity: 1;
            transform: scale(1);
        }

        #resultMessage {
            color: var(--primary);
            font-family: var(--font-tech);
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-top: 2rem;
            text-shadow: 0 0 15px var(--primary);
            background: var(--card-bg);
            padding: 1.5rem 3rem;
            border-radius: 10px;
            border: 1px solid var(--primary);
            box-shadow: var(--neon-shadow);
            letter-spacing: 2px;
        }

        #retryButton, #exploreCutsButton {
            margin-top: 1.5rem;
            padding: 1rem 2rem;
            font-family: var(--font-tech);
            font-size: 1.2rem;
            background: var(--tech-gradient);
            color: var(--light);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: var(--neon-shadow);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #retryButton:hover, #exploreCutsButton:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 209, 255, 0.7);
        }

        .analysis-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--neon-shadow);
            border: 1px solid rgba(0, 209, 255, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .card.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 209, 255, 0.3);
            border-color: rgba(0, 209, 255, 0.3);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-family: var(--font-tech);
            font-size: 1.3rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            letter-spacing: 1px;
        }

        .card h2 i {
            font-size: 1.2rem;
            color: var(--gold);
        }

        .card p {
            margin-bottom: 0.8rem;
            color: var(--light);
            font-weight: 300;
            line-height: 1.7;
        }

        .card .highlight {
            color: var(--gold);
            font-weight: 500;
        }

        .landmark-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-top: 1.2rem;
        }

        .landmark-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            background: rgba(0, 209, 255, 0.1);
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 209, 255, 0.1);
            transition: all 0.3s ease;
        }

        .landmark-item:hover {
            background: rgba(0, 209, 255, 0.2);
            transform: translateY(-2px);
        }

        .landmark-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 8px currentColor;
        }

        .measurement-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px dashed rgba(0, 209, 255, 0.2);
            font-size: 0.9rem;
        }

        .measurement-value {
            font-weight: 500;
            color: var(--gold);
            font-family: var(--font-tech);
            letter-spacing: 1px;
        }

        .face-shape-display {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 209, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--primary);
            font-family: var(--font-tech);
            letter-spacing: 1px;
        }

        .product-link {
            display: inline-flex;
            align-items: center;
            margin-top: 1rem;
            color: var(--light);
            font-weight: 500;
            transition: all 0.3s;
            background: var(--tech-gradient);
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 209, 255, 0.3);
        }

        .product-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 209, 255, 0.4);
        }

        .product-link i {
            margin-left: 0.5rem;
            transition: transform 0.3s;
        }

        .product-link:hover i {
            transform: translateX(3px);
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .share-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .share-btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.3), transparent);
            top: -50%;
            left: -50%;
            transform: rotate(30deg);
            transition: all 0.3s;
        }

        .share-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .share-btn:hover::after {
            top: 100%;
            left: 100%;
        }

        .whatsapp { background: #25D366; }
        .instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .facebook { background: #3b5998; }
        .link { background: var(--primary); }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .instructions {
            text-align: center;
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: 1rem;
            font-weight: 300;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .container {
                padding: 1rem;
            }

            #startButton {
                padding: 1rem 2rem;
                font-size: 1.2rem;
            }

            .card h2 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>

    <header>
        <h1>HAIR BY MARCIO</h1>
        <p>DIAGN√ìSTICO FACIAL 3.0 | TECNOLOGIA DE PONTA</p>
    </header>

    <div class="container">
        <div class="main-content">
            <section class="scanner-section" id="scannerContainer">
                <button id="startButton">INICIAR SCAN 3D</button>
                <video id="webcam" playsinline></video>
                <canvas id="canvas"></canvas>
                <canvas id="staticCanvas"></canvas>
                <div id="scanOverlay"></div>
                <div id="scanLine"></div>
                <div class="face-guide"></div>
                <div class="status" id="status">SISTEMA PRONTO</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="resultContainer">
                    <div id="resultMessage">MAPEAMENTO FACIAL COMPLETO</div>
                    <button id="retryButton">REFAZER AN√ÅLISE</button>
                    <button id="exploreCutsButton">EXPLORAR CORTES</button>
                </div>
            </section>

            <section class="analysis-section">
                <div class="card" id="analysis-card">
                    <h2><i class="fas fa-ruler-combined"></i> AN√ÅLISE GEOM√âTRICA</h2>
                    <div class="face-shape-display" id="face-shape">
                        <span id="face-shape-text">AGUARDANDO ESCANEAMENTO 3D</span>
                        <span class="loading" id="face-shape-loading"></span>
                    </div>
                    <div id="measurements">
                        <div class="measurement-item">
                            <span>Largura da testa:</span>
                            <span class="measurement-value" id="forehead-width">--</span>
                        </div>
                        <div class="measurement-item">
                            <span>Largura das bochechas:</span>
                            <span class="measurement-value" id="cheek-width">--</span>
                        </div>
                        <div class="measurement-item">
                            <span>Largura do maxilar:</span>
                            <span class="measurement-value" id="jaw-width">--</span>
                        </div>
                        <div class="measurement-item">
                            <span>Altura do rosto:</span>
                            <span class="measurement-value" id="face-height">--</span>
                        </div>
                        <div class="measurement-item">
                            <span>Propor√ß√£o facial:</span>
                            <span class="measurement-value" id="face-ratio">--</span>
                        </div>
                    </div>
                </div>

                <div class="card" id="hairstyle-card">
                    <h2><i class="fas fa-cut"></i> SUGEST√ÉO DE ESTILO</h2>
                    <p class="highlight" id="hairstyle-suggestion">AGUARDANDO AN√ÅLISE FACIAL...</p>
                    <p id="avoid-suggestion"></p>
                    <a id="hairstyle-link" href="haircuts.html" target="_blank" rel="noopener" class="product-link">
                        VER CORTES RECOMENDADOS <i class="fas fa-cut"></i>
                    </a>
                </div>

                <div class="card" id="product-card">
                    <h2><i class="fas fa-pump-soap"></i> PRODUTOS RECOMENDADOS</h2>
                    <p id="product-suggestion">AGUARDANDO AN√ÅLISE FACIAL...</p>
                    <a id="product-link" href="#" target="_blank" rel="noopener" class="product-link">
                        VER PRODUTO RECOMENDADO <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>

                <div class="share-buttons">
                    <button class="share-btn whatsapp" id="share-whatsapp" title="Compartilhar no WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button class="share-btn instagram" id="share-instagram" title="Compartilhar no Instagram">
                        <i class="fab fa-instagram"></i>
                    </button>
                    <button class="share-btn facebook" id="share-facebook" title="Compartilhar no Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="share-btn link" id="copy-link" title="Copiar link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        particlesJS("particles-js", {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#00D1FF"
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    }
                },
                "opacity": {
                    "value": 0.3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 0.1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#00D1FF",
                    "opacity": 0.2,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push"
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 140,
                        "line_linked": {
                            "opacity": 0.5
                        }
                    },
                    "push": {
                        "particles_nb": 4
                    }
                }
            },
            "retina_detect": true
        });

        const elements = {
            video: document.getElementById('webcam'),
            canvas: document.getElementById('canvas'),
            staticCanvas: document.getElementById('staticCanvas'),
            staticCtx: document.getElementById('staticCanvas').getContext('2d'),
            ctx: document.getElementById('canvas').getContext('2d'),
            startBtn: document.getElementById('startButton'),
            scanLine: document.getElementById('scanLine'),
            overlay: document.getElementById('scanOverlay'),
            faceGuide: document.querySelector('.face-guide'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progressBar'),
            progressContainer: document.querySelector('.progress-container'),
            resultContainer: document.getElementById('resultContainer'),
            resultMessage: document.getElementById('resultMessage'),
            retryBtn: document.getElementById('retryButton'),
            exploreCutsBtn: document.getElementById('exploreCutsButton')
        };

        const config = {
            scanSpeed: 0.7,
            connections: [
                [10, 338], [338, 297], [297, 332], [332, 284], [284, 251], [251, 389], [389, 356],
                [356, 454], [454, 323], [323, 361], [361, 288], [288, 397], [397, 365], [365, 379],
                [379, 378], [378, 400], [400, 377], [377, 152], [152, 148], [148, 176], [176, 149],
                [149, 150], [150, 136], [136, 172], [172, 58], [58, 132], [132, 93], [93, 234],
                [234, 127], [127, 162], [162, 21], [21, 54], [54, 103], [103, 67], [67, 109], [109, 10],
                [168, 6], [6, 197], [197, 195], [195, 5], [5, 4], [4, 45], [45, 220], [220, 115],
                [78, 95], [95, 88], [88, 178], [178, 87], [87, 14], [14, 317], [317, 402], [402, 318],
                [33, 246], [246, 161], [161, 160], [160, 159], [159, 158], [158, 157], [157, 173],
                [362, 398], [398, 384], [384, 385], [385, 386], [386, 387], [387, 388], [388, 466]
            ],
            lineStyle: {
                active: 'rgba(0, 209, 255, 0.9)',
                static: 'rgba(0, 240, 255, 0.8)',
                width: 1.3,
                pointSize: 2.2
            }
        };

        let state = {
            scanning: false,
            progress: 0,
            faceDetected: false,
            lastLandmarks: null,
            currentResultImage: null,
            measurementBuffer: [],
            bufferSize: 10,
            faceShape: null
        };

        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.75,
            minTrackingConfidence: 0.75
        });

        faceMesh.onResults(processResults);

        document.addEventListener('DOMContentLoaded', () => {
            gsap.to("#analysis-card", {
                duration: 0.8,
                y: 0,
                opacity: 1,
                ease: "power3.out",
                delay: 0.2
            });

            gsap.to("#hairstyle-card", {
                duration: 0.8,
                y: 0,
                opacity: 1,
                ease: "power3.out",
                delay: 0.4
            });

            gsap.to("#product-card", {
                duration: 0.8,
                y: 0,
                opacity: 1,
                ease: "power3.out",
                delay: 0.6,
                onComplete: () => {
                    document.querySelectorAll('.card').forEach(card => {
                        card.classList.add('visible');
                    });
                }
            });
        });

        elements.startBtn.addEventListener('click', initScanner);
        elements.retryBtn.addEventListener('click', initScanner);
        elements.exploreCutsBtn.addEventListener('click', () => {
            window.location.href = `haircuts.html?shape=${state.faceShape}`;
        });

        function initScanner() {
            state = {
                scanning: true,
                progress: 0,
                faceDetected: false,
                lastLandmarks: null,
                currentResultImage: null,
                measurementBuffer: [],
                faceShape: null
            };

            const scannerRect = document.getElementById('scannerContainer').getBoundingClientRect();
            elements.canvas.width = scannerRect.width;
            elements.canvas.height = scannerRect.height;
            elements.staticCanvas.width = scannerRect.width;
            elements.staticCanvas.height = scannerRect.height;

            elements.startBtn.style.display = 'none';
            elements.video.style.display = 'block';
            elements.canvas.style.display = 'block';
            elements.overlay.style.display = 'block';
            elements.scanLine.style.display = 'block';
            elements.faceGuide.style.display = 'block';
            elements.status.style.display = 'block';
            elements.progressContainer.style.display = 'block';
            elements.resultContainer.style.display = 'none';
            elements.resultContainer.classList.remove('active');

            document.getElementById('face-shape-text').textContent = "ANALISANDO FORMATO DO ROSTO...";
            document.getElementById('face-shape-loading').style.display = 'inline-block';
            document.getElementById('hairstyle-suggestion').textContent = "AGUARDANDO AN√ÅLISE FACIAL...";
            document.getElementById('avoid-suggestion').textContent = "";
            document.getElementById('hairstyle-link').href = "#";
            document.getElementById('product-suggestion').textContent = "AGUARDANDO AN√ÅLISE FACIAL...";
            document.getElementById('forehead-width').textContent = "--";
            document.getElementById('cheek-width').textContent = "--";
            document.getElementById('jaw-width').textContent = "--";
            document.getElementById('face-height').textContent = "--";
            document.getElementById('face-ratio').textContent = "--";

            new Camera(elements.video, {
                onFrame: async () => await faceMesh.send({ image: elements.video }),
                width: 1280,
                height: 720
            }).start();

            elements.status.textContent = "POSICIONE SEU ROSTO NA √ÅREA DE SCAN";
            elements.progressBar.style.width = '0%';
            elements.progressBar.style.background = 'linear-gradient(90deg, #00D1FF, #9C27B0)';

            gsap.from("#scannerContainer", {
                duration: 0.8,
                scale: 0.95,
                opacity: 0,
                y: 20,
                ease: "power3.out"
            });
        }

        function processResults(results) {
            if (!state.scanning) return;

            elements.ctx.save();
            elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
            elements.ctx.drawImage(results.image, 0, 0, elements.canvas.width, elements.canvas.height);

            if (results.multiFaceLandmarks?.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                const alignmentFeedback = checkFaceAlignment(landmarks);

                if (alignmentFeedback.isAligned) {
                    state.lastLandmarks = landmarks;

                    if (!state.faceDetected) {
                        state.faceDetected = true;
                        elements.status.textContent = "ANALISANDO DADOS BIOMO√âTRICOS";

                        gsap.to(elements.faceGuide, {
                            duration: 0.5,
                            scale: 1.05,
                            repeat: 1,
                            yoyo: true,
                            ease: "power1.inOut"
                        });
                    }

                    if (state.progress < 100) {
                        state.progress += config.scanSpeed;
                        elements.progressBar.style.width = state.progress + '%';
                        drawFaceLines(results.multiFaceLandmarks, elements.ctx, true);
                        updateFaceAnalysis(landmarks);
                    } else {
                        completeScan();
                    }
                } else {
                    state.faceDetected = false;
                    state.progress = Math.max(0, state.progress - 1);
                    elements.progressBar.style.width = state.progress + '%';
                    elements.status.textContent = alignmentFeedback.message;
                    drawAlignmentGuides(elements.ctx, alignmentFeedback);
                }
            } else {
                state.faceDetected = false;
                state.progress = Math.max(0, state.progress - 1);
                elements.progressBar.style.width = state.progress + '%';
                elements.status.textContent = "CENTRALIZE SEU ROSTO NA √ÅREA DE SCAN";
            }

            elements.ctx.restore();
        }

        function checkFaceAlignment(landmarks) {
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];
            const noseTip = landmarks[1];
            const canvasCenterX = elements.canvas.width / 2;
            const canvasCenterY = elements.canvas.height / 2;
            const faceGuideWidth = 280;
            const faceGuideHeight = 380;

            const faceCenterX = (leftEye.x + rightEye.x) / 2 * elements.canvas.width;
            const faceCenterY = (leftEye.y + rightEye.y) / 2 * elements.canvas.height;
            const offsetX = faceCenterX - canvasCenterX;
            const offsetY = faceCenterY - canvasCenterY;

            const eyeDy = rightEye.y - leftEye.y;
            const eyeDx = rightEye.x - leftEye.x;
            const rollAngle = Math.atan2(eyeDy, eyeDx) * 180 / Math.PI;

            const eyeDistance = distanceBetween(leftEye, rightEye) * elements.canvas.width;
            const idealEyeDistance = faceGuideWidth * 0.3;

            let message = "POSICIONE SEU ROSTO NA √ÅREA DE SCAN";
            let isAligned = true;
            const feedback = { offsetX, offsetY, rollAngle };

            if (Math.abs(offsetX) > faceGuideWidth * 0.1) {
                message = offsetX > 0 ? "MOVA O ROSTO PARA A ESQUERDA" : "MOVA O ROSTO PARA A DIREITA";
                isAligned = false;
            } else if (Math.abs(offsetY) > faceGuideHeight * 0.1) {
                message = offsetY > 0 ? "MOVA O ROSTO PARA CIMA" : "MOVA O ROSTO PARA BAIXO";
                isAligned = false;
            } else if (Math.abs(rollAngle) > 3) {
                message = rollAngle > 0 ? "INCLINE A CABE√áA PARA A ESQUERDA" : "INCLINE A CABE√áA PARA A DIREITA";
                isAligned = false;
            } else if (eyeDistance < idealEyeDistance * 0.8 || eyeDistance > idealEyeDistance * 1.2) {
                message = eyeDistance < idealEyeDistance ? "APROXIME-SE DA C√ÇMERA" : "AFASTE-SE DA C√ÇMERA";
                isAligned = false;
            }

            return { isAligned, message, feedback };
        }

        function drawAlignmentGuides(ctx, alignmentFeedback) {
            const { offsetX, offsetY, rollAngle } = alignmentFeedback.feedback;
            const canvasCenterX = elements.canvas.width / 2;
            const canvasCenterY = elements.canvas.height / 2;

            ctx.strokeStyle = 'rgba(255, 50, 50, 0.8)';
            ctx.lineWidth = 2;

            if (Math.abs(offsetX) > 50) {
                ctx.beginPath();
                ctx.moveTo(canvasCenterX + (offsetX > 0 ? -50 : 50), canvasCenterY);
                ctx.lineTo(canvasCenterX + (offsetX > 0 ? -30 : 30), canvasCenterY - 10);
                ctx.lineTo(canvasCenterX + (offsetX > 0 ? -30 : 30), canvasCenterY + 10);
                ctx.closePath();
                ctx.stroke();
                ctx.fillStyle = 'rgba(255, 50, 50, 0.5)';
                ctx.fill();
            }

            if (Math.abs(offsetY) > 50) {
                ctx.beginPath();
                ctx.moveTo(canvasCenterX, canvasCenterY + (offsetY > 0 ? -50 : 50));
                ctx.lineTo(canvasCenterX - 10, canvasCenterY + (offsetY > 0 ? -30 : 30));
                ctx.lineTo(canvasCenterX + 10, canvasCenterY + (offsetY > 0 ? -30 : 30));
                ctx.closePath();
                ctx.stroke();
                ctx.fillStyle = 'rgba(255, 50, 50, 0.5)';
                ctx.fill();
            }
        }

        function drawFaceLines(landmarks, ctx, isActive = false) {
            const style = config.lineStyle;

            ctx.strokeStyle = isActive ? style.active : style.static;
            ctx.lineWidth = style.width;
            ctx.globalCompositeOperation = 'lighter';

            ctx.beginPath();
            config.connections.forEach(([startIdx, endIdx]) => {
                const start = landmarks[0][startIdx];
                const end = landmarks[0][endIdx];
                if (start && end) {
                    ctx.moveTo(start.x * elements.canvas.width, start.y * elements.canvas.height);
                    ctx.lineTo(end.x * elements.canvas.width, end.y * elements.canvas.height);
                }
            });
            ctx.stroke();

            ctx.fillStyle = style.active;
            landmarks[0].forEach((point, i) => {
                if (i % 5 === 0) {
                    ctx.beginPath();
                    ctx.arc(
                        point.x * elements.canvas.width,
                        point.y * elements.canvas.height,
                        style.pointSize, 0, Math.PI * 2
                    );
                    ctx.fill();
                }
            });
        }

        function updateFaceAnalysis(landmarks) {
            if (!landmarks) return;

            const measurements = getFacialMeasurements(landmarks);
            state.measurementBuffer.push(measurements);
            if (state.measurementBuffer.length > state.bufferSize) {
                state.measurementBuffer.shift();
            }

            const averagedMeasurements = averageMeasurements(state.measurementBuffer);

            document.getElementById('forehead-width').textContent = averagedMeasurements.foreheadWidth.toFixed(1) + " cm";
            document.getElementById('cheek-width').textContent = averagedMeasurements.cheekWidth.toFixed(1) + " cm";
            document.getElementById('jaw-width').textContent = averagedMeasurements.jawWidth.toFixed(1) + " cm";
            document.getElementById('face-height').textContent = averagedMeasurements.faceHeight.toFixed(1) + " cm";
            document.getElementById('face-ratio').textContent = averagedMeasurements.faceRatio.toFixed(2);

            const faceShape = determineFaceShape(averagedMeasurements);
            state.faceShape = faceShape;
            document.getElementById('face-shape-text').textContent = faceShape;
            document.getElementById('face-shape-loading').style.display = 'none';

            generateRecommendations(faceShape, averagedMeasurements);
        }

        function averageMeasurements(buffer) {
            if (buffer.length === 0) return {};
            const keys = Object.keys(buffer[0]);
            const sum = buffer.reduce((acc, curr) => {
                keys.forEach(key => {
                    acc[key] = (acc[key] || 0) + curr[key];
                });
                return acc;
            }, {});
            return keys.reduce((acc, key) => {
                acc[key] = sum[key] / buffer.length;
                return acc;
            }, {});
        }

        function getFacialMeasurements(landmarks) {
            const foreheadPointsLeft = [234, 227];
            const foreheadPointsRight = [454, 447];
            const cheekPointsLeft = [205, 203];
            const cheekPointsRight = [425, 423];
            const jawPointsLeft = [172, 136];
            const jawPointsRight = [397, 361];
            const chin = landmarks[152];
            const hairline = landmarks[10];
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];

            const canvasWidth = elements.canvas.width;
            const canvasHeight = elements.canvas.height;
            const pupilDistance = distanceBetween(leftEye, rightEye) * canvasWidth;
            const referenceDistance = 6.3;
            const scaleFactor = referenceDistance / pupilDistance;

            const toCm = (distance) => distance * canvasWidth * scaleFactor;

            const foreheadWidth = averageDistance(foreheadPointsLeft, foreheadPointsRight, landmarks);
            const cheekWidth = averageDistance(che.ekPointsLeft, cheekPointsRight, landmarks);
            const jawWidth = averageDistance(jawPointsLeft, jawPointsRight, landmarks);
            const faceHeight = toCm(distanceBetween(hairline, chin)) * (canvasHeight / canvasWidth);

            const foreheadToCheekRatio = foreheadWidth / cheekWidth;
            const jawToCheekRatio = jawWidth / cheekWidth;
            const faceRatio = faceHeight / cheekWidth;

            return {
                foreheadWidth: Math.min(foreheadWidth, 20),
                cheekWidth: Math.min(cheekWidth, 20),
                jawWidth: Math.min(jawWidth, 20),
                faceHeight: Math.min(faceHeight, 30),
                faceRatio,
                foreheadToCheekRatio,
                jawToCheekRatio
            };
        }

        function averageDistance(leftIndices, rightIndices, landmarks) {
            const distances = [];
            leftIndices.forEach(leftIdx => {
                rightIndices.forEach(rightIdx => {
                    const dist = distanceBetween(landmarks[leftIdx], landmarks[rightIdx]);
                    if (dist > 0) distances.push(dist);
                });
            });
            const avgDist = distances.length > 0 ? distances.reduce((a, b) => a + b, 0) / distances.length : 0;
            return avgDist * elements.canvas.width * (6.3 / (distanceBetween(landmarks[33], landmarks[263]) * elements.canvas.width));
        }

        function distanceBetween(point1, point2) {
            if (!point1 || !point2) return 0;
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function determineFaceShape(measurements) {
            const {
                foreheadWidth,
                cheekWidth,
                jawWidth,
                faceHeight,
                foreheadToCheekRatio,
                jawToCheekRatio,
                faceRatio
            } = measurements;

            const avgWidth = (foreheadWidth + cheekWidth + jawWidth) / 3;
            const heightToWidthRatio = faceHeight / avgWidth;

            if (heightToWidthRatio > 1.4 && heightToWidthRatio < 1.6 && foreheadToCheekRatio < 0.98 && jawToCheekRatio < 0.98) {
                return "OVAL";
            } else if (heightToWidthRatio <= 1.15 && Math.abs(foreheadWidth - cheekWidth) < 1.0 && Math.abs(jawWidth - cheekWidth) < 1.0) {
                return "REDONDO";
            } else if (heightToWidthRatio >= 1.6 && Math.abs(foreheadWidth - jawWidth) < 1.0 && Math.abs(cheekWidth - jawWidth) < 1.0) {
                return "RETANGULAR";
            } else if (heightToWidthRatio >= 1.15 && heightToWidthRatio < 1.4 && Math.abs(foreheadWidth - jawWidth) < 1.0 && Math.abs(cheekWidth - jawWidth) < 1.0) {
                return "QUADRADO";
            } else if (foreheadWidth > jawWidth + 1.0 && cheekWidth > jawWidth + 0.8 && foreheadToCheekRatio > 0.95 && jawToCheekRatio < 0.95) {
                return "CORA√á√ÉO";
            }
            return "OVAL";
        }

        function generateRecommendations(faceShape, measurements) {
            let hairstyleSuggestion = "";
            let avoidSuggestion = "";
            let productSuggestion = "";
            let productLink = "#";
            let hairstyleLink = `haircuts.html?shape=${faceShape}`;

            const { faceRatio } = measurements;
            const isLongFace = faceRatio > 1.5;

            switch (faceShape) {
                case "REDONDO":
                    hairstyleSuggestion = "Opte por um **Undercut com volume** ou **Fade com topete**. Esses cortes adicionam altura, alongando visualmente o rosto.";
                    avoidSuggestion = "Evite **franja reta pesada** ou **cortes bowl**, que acentuam a redondeza.";
                    productSuggestion = "Use a **Pomada Matte da Redken Brews** para textura e fixa√ß√£o no topo.";
                    productLink = "https://www.redken.com.br/produtos/styling/pomada-matte";
                    break;
                case "QUADRADO":
                    hairstyleSuggestion = "Experimente um **Corte texturizado com franja lateral** ou **Pompadour suave**. Eles suavizam os √¢ngulos do maxilar.";
                    avoidSuggestion = "Evite **cortes militares retos** ou **buzz cuts**, que destacam a angularidade.";
                    productSuggestion = "A **Cera Modeladora da L'Or√©al Professionnel Tecni.Art** d√° brilho e controle.";
                    productLink = "https://www.lorealprofessionnel.com.br/produtos/tecniart/cera";
                    break;
                case "CORA√á√ÉO":
                    hairstyleSuggestion = "Escolha um **Corte m√©dio com ondas** ou **Side Part com volume**. Eles equilibram a testa larga e o queixo estreito.";
                    avoidSuggestion = "Evite **cortes muito curtos no topo** ou **topetes altos**, que acentuam o queixo.";
                    productSuggestion = "O **Mousse Volumizing da Schwarzkopf** adiciona corpo √†s laterais.";
                    productLink = "https://www.schwarzkopf.com/products/styling/mousse";
                    break;
                case "OVAL":
                    hairstyleSuggestion = "Voc√™ tem versatilidade! Tente um **Undercut moderno**, **Side Part cl√°ssico** ou **Texturizado com franja**. Todos valorizam suas propor√ß√µes.";
                    avoidSuggestion = "Evite **franjas muito longas** que escondem o rosto ou **cortes muito volumosos**.";
                    productSuggestion = "A **Argila Modeladora da American Crew** permite diversos estilos com fixa√ß√£o m√©dia.";
                    productLink = "https://www.americancrew.com.br/products/argila";
                    break;
                case "RETANGULAR":
                    hairstyleSuggestion = isLongFace
                        ? "Prefira um **Corte com franja lateral** ou **Texturizado com volume nas laterais** para encurtar o rosto."
                        : "Um **Corte m√©dio com camadas** ou **Franja assim√©trica** equilibra o comprimento.";
                    avoidSuggestion = "Evite **cortes muito altos no topo** ou **laterais muito raspadas**, que alongam ainda mais.";
                    productSuggestion = "Use o **Gel Fixador da Paul Mitchell** para defini√ß√£o e controle.";
                    productLink = "https://www.paulmitchell.com.br/products/styling/gel";
                    break;
                default:
                    hairstyleSuggestion = "Estilo personalizado baseado nas suas medidas faciais √∫nicas.";
                    productSuggestion = "Produtos personalizados para suas necessidades espec√≠ficas.";
                    hairstyleLink = "haircuts.html?shape=OVAL";
            }

            document.getElementById('hairstyle-suggestion').textContent = hairstyleSuggestion;
            document.getElementById('avoid-suggestion').textContent = avoidSuggestion;
            document.getElementById('hairstyle-link').href = hairstyleLink;
            document.getElementById('product-suggestion').textContent = productSuggestion;
            document.getElementById('product-link').href = productLink;
        }

        function completeScan() {
            state.scanning = false;

            if (elements.video.srcObject) {
                elements.video.srcObject.getTracks().forEach(track => track.stop());
            }

            elements.staticCtx.clearRect(0, 0, elements.staticCanvas.width, elements.staticCanvas.height);
            elements.staticCtx.drawImage(elements.canvas, 0, 0, elements.staticCanvas.width, elements.staticCanvas.height);

            if (state.lastLandmarks) {
                drawFaceLines([state.lastLandmarks], elements.staticCtx, false);
            }

            elements.video.style.display = 'none';
            elements.canvas.style.display = 'none';
            elements.scanLine.style.display = 'none';
            elements.faceGuide.style.display = 'none';
            elements.progressContainer.style.display = 'none';

            elements.staticCanvas.style.display = 'block';
            elements.status.textContent = "DIAGN√ìSTICO COMPLETO!";
            elements.progressBar.style.background = "var(--gold)";

            elements.resultContainer.style.display = 'flex';
            setTimeout(() => {
                elements.resultContainer.classList.add('active');
                gsap.from("#retryButton", {
                    duration: 0.5,
                    y: 20,
                    opacity: 0,
                    ease: "power3.out",
                    delay: 0.5
                });
                gsap.from("#exploreCutsButton", {
                    duration: 0.5,
                    y: 20,
                    opacity: 0,
                    ease: "power3.out",
                    delay: 0.7
                });
            }, 100);

            if (state.lastLandmarks) {
                updateFaceAnalysis(state.lastLandmarks);
            }

            captureResultImage();
            setupShareButtons();
        }

        function captureResultImage() {
            html2canvas(document.getElementById('scannerContainer'), {
                backgroundColor: null,
                scale: 1,
                logging: false,
                useCORS: true
            }).then(canvas => {
                state.currentResultImage = canvas.toDataURL('image/png');
            });
        }

        function setupShareButtons() {
            if (!setupShareButtons.initialized) {
                document.getElementById('share-whatsapp').addEventListener('click', () => {
                    const text = "Confira meu diagn√≥stico facial completo feito com a tecnologia Hair by Marcio!";
                    const url = encodeURIComponent(window.location.href);
                    window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
                });

                document.getElementById('share-instagram').addEventListener('click', () => {
                    alert("Para compartilhar no Instagram, salve a imagem e poste diretamente no app!");
                });

                document.getElementById('share-facebook').addEventListener('click', () => {
                    const url = encodeURIComponent(window.location.href);
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
                });

                document.getElementById('copy-link').addEventListener('click', () => {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        alert("Link copiado para a √°rea de transfer√™ncia!");
                    });
                });

                setupShareButtons.initialized = true;
            }
        }
    </script>
</body>
</html>
